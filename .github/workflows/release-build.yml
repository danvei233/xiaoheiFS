name: Build & Upload Release Assets

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to upload assets to (e.g. v1.2.3)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve tag
        id: tag
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "value=${{ github.event.release.tag_name }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "value=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: backend/go.mod
          cache-dependency-path: backend/go.sum

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Build (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "[1/3] Build frontend..."
          Push-Location frontend
          npm ci
          npm run build
          Pop-Location

          Write-Host "[2/3] Copy dist to build/windows/static..."
          Remove-Item -Recurse -Force build/windows -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Force build/windows/static | Out-Null
          Copy-Item -Path frontend/dist/* -Destination build/windows/static -Recurse -Force

          Write-Host "[3/3] Build backend (windows)..."
          Push-Location backend
          go build -o ..\\build\\windows\\server.exe .\\cmd\\server
          Pop-Location

      - name: Build (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          echo "[1/3] Build frontend..."
          cd frontend
          npm ci
          npm run build
          cd ..

          echo "[2/3] Copy dist to build/linux/static..."
          rm -rf build/linux
          mkdir -p build/linux/static
          cp -a frontend/dist/. build/linux/static/

          echo "[3/3] Build backend (linux)..."
          cd backend
          go build -o ../build/linux/server ./cmd/server

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $tag = '${{ steps.tag.outputs.value }}'
          New-Item -ItemType Directory -Force dist | Out-Null
          $zip = "dist/xiaohei-$tag-windows-amd64.zip"
          if (Test-Path $zip) { Remove-Item -Force $zip }
          Push-Location build/windows
          Compress-Archive -Path server.exe, static -DestinationPath (Resolve-Path "../../$zip")
          Pop-Location
          (Get-FileHash $zip -Algorithm SHA256).Hash.ToLower() + "  " + (Split-Path $zip -Leaf) | Set-Content "$zip.sha256" -NoNewline

      - name: Package (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          tag='${{ steps.tag.outputs.value }}'
          mkdir -p dist
          out="dist/xiaohei-$tag-linux-amd64.tar.gz"
          tar -C build/linux -czf "$out" server static
          hash="$(sha256sum "$out" | cut -d' ' -f1)"
          echo "$hash  $(basename "$out")" > "$out.sha256"

      - name: Upload assets to release
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ steps.tag.outputs.value }}
        shell: bash
        run: |
          gh release upload "$TAG" dist/* --clobber --repo "$GITHUB_REPOSITORY"

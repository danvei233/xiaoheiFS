name: Build & Upload Release Assets

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to upload assets to (e.g. v1.2.3)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve tag
        id: tag
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "value=${{ github.event.release.tag_name }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "value=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: backend/go.mod
          cache-dependency-path: backend/go.sum

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Build (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "[1/5] Build frontend/static/backend via script/build-win.bat..."
          cmd /c script\build-win.bat

          Write-Host "[4/5] Build built-in plugins (windows)..."
          Push-Location backend
          $plugins = @(
            @{ id = "payment/ezpay"; pkg = "./plugin-demo/pluginv1/payment_ezpay" },
            @{ id = "payment/wechatpay_v3"; pkg = "./plugin-demo/pluginv1/payment_wechatpay_v3" },
            @{ id = "payment/alipay_open"; pkg = "./plugin-demo/pluginv1/payment_alipay_open" },
            @{ id = "sms/alisms"; pkg = "./plugin-demo/pluginv1/sms_alisms_mock" },
            @{ id = "sms/tencent_sms"; pkg = "./plugin-demo/pluginv1/sms_tencent_mock" },
            @{ id = "kyc/aliyun_kyc"; pkg = "./plugin-demo/pluginv1/kyc_aliyun_mock" },
            @{ id = "kyc/tencent_kyc"; pkg = "./plugin-demo/pluginv1/kyc_tencent_mock" },
            @{ id = "automation/lightboat"; pkg = "./plugin-demo/pluginv1/automation_lightboat" }
          )
          $env:CGO_ENABLED = "0"
          $env:GOOS = "windows"
          $env:GOARCH = "amd64"
          foreach ($p in $plugins) {
            $outDir = Join-Path "plugins/$($p.id)" "bin/windows_amd64"
            New-Item -ItemType Directory -Force $outDir | Out-Null
            $outFile = Join-Path $outDir "plugin.exe"
            go build -o $outFile $p.pkg
          }
          Pop-Location

          Write-Host "[5/5] Copy plugins to build/windows/plugins..."
          Remove-Item -Recurse -Force build/windows/plugins -ErrorAction SilentlyContinue
          Copy-Item -Path backend/plugins -Destination build/windows/plugins -Recurse -Force

      - name: Build (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          echo "[1/5] Build frontend/static/backend via script/build-linux.sh..."
          chmod +x script/build-linux.sh
          ./script/build-linux.sh

          echo "[4/5] Build built-in plugins (linux)..."
          cd backend
          export CGO_ENABLED=0
          export GOOS=linux
          export GOARCH=amd64
          for p in \
            "payment/ezpay ./plugin-demo/pluginv1/payment_ezpay" \
            "payment/wechatpay_v3 ./plugin-demo/pluginv1/payment_wechatpay_v3" \
            "payment/alipay_open ./plugin-demo/pluginv1/payment_alipay_open" \
            "sms/alisms ./plugin-demo/pluginv1/sms_alisms_mock" \
            "sms/tencent_sms ./plugin-demo/pluginv1/sms_tencent_mock" \
            "kyc/aliyun_kyc ./plugin-demo/pluginv1/kyc_aliyun_mock" \
            "kyc/tencent_kyc ./plugin-demo/pluginv1/kyc_tencent_mock" \
            "automation/lightboat ./plugin-demo/pluginv1/automation_lightboat"; do
              id="$(echo "$p" | cut -d' ' -f1)"
              pkg="$(echo "$p" | cut -d' ' -f2)"
              out_dir="plugins/$id/bin/linux_amd64"
              mkdir -p "$out_dir"
              go build -o "$out_dir/plugin" "$pkg"
          done
          cd ..

          echo "[5/5] Copy plugins to build/linux/plugins..."
          rm -rf build/linux/plugins
          cp -a backend/plugins build/linux/

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $tag = '${{ steps.tag.outputs.value }}'
          New-Item -ItemType Directory -Force dist | Out-Null
          $zip = "dist/xiaohei-$tag-windows-amd64.zip"
          if (Test-Path $zip) { Remove-Item -Force $zip }
          Push-Location build/windows
          $repoRoot = (Resolve-Path ../..).Path
          $dest = Join-Path $repoRoot $zip
          Compress-Archive -Path server.exe, static, plugins -DestinationPath $dest -Force
          Pop-Location
          (Get-FileHash $zip -Algorithm SHA256).Hash.ToLower() + "  " + (Split-Path $zip -Leaf) | Set-Content "$zip.sha256" -NoNewline

      - name: Package (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          tag='${{ steps.tag.outputs.value }}'
          mkdir -p dist
          out="dist/xiaohei-$tag-linux-amd64.tar.gz"
          tar -C build/linux -czf "$out" server static plugins
          hash="$(sha256sum "$out" | cut -d' ' -f1)"
          echo "$hash  $(basename "$out")" > "$out.sha256"

      - name: Upload assets to release
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ steps.tag.outputs.value }}
        shell: bash
        run: |
          gh release upload "$TAG" dist/* --clobber --repo "$GITHUB_REPOSITORY"

# Feature Specification: 收入统计初版

**Feature Branch**: `001-revenue-analytics`  
**Created**: 2026-02-20  
**Status**: Draft  
**Input**: User description: "收入统计初版 时间跨度可自由选择 介于目前商品等级为:类型-地区-线路-套餐 ... 四个层级可选择 占比图 趋势图 同比环比 top5 真实数据 明细表"

## Clarifications

### Session 2026-02-20

- Q: 四层级筛选如何体现“依次递进”关系？ → A: 严格级联选择：查“线路/套餐”前，必须先明确上级（类型→地区→线路）。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 查看收入总览 (Priority: P1)

作为管理员，我可以选择任意合法时间范围和一个商品层级（类型/地区/线路/套餐）查看收入总览，包括占比、趋势、同比、环比和 Top5，从而快速判断经营变化。

**Why this priority**: 这是该功能的核心价值，直接支撑管理决策。

**Independent Test**: 在有真实历史交易数据的环境中，管理员完成一次查询后可同时看到占比图、趋势图、同比环比和 Top5，且各模块口径一致。

**Acceptance Scenarios**:

1. **Given** 管理员已登录并有权限，**When** 选择时间范围与“地区”层级并发起查询，**Then** 系统返回该范围内按地区统计的占比、趋势、同比环比和 Top5。
2. **Given** 管理员已完成一次查询，**When** 切换层级为“套餐”，**Then** 系统基于相同时间范围返回按套餐统计的完整总览。

---

### User Story 2 - 查看收入明细 (Priority: P2)

作为管理员，我可以在同一筛选条件下查看收入明细表，用于核对图表数据来源与定位异常记录。

**Why this priority**: 没有明细就无法验证总览结果，影响财务可追溯性。

**Independent Test**: 管理员在完成总览查询后打开明细表，能看到与筛选条件一致的分页记录，且汇总金额可对齐总览口径。

**Acceptance Scenarios**:

1. **Given** 管理员已完成总览查询，**When** 打开明细表，**Then** 系统展示同筛选条件下的收入记录并支持分页浏览。
2. **Given** 管理员在明细表中修改排序方式，**When** 重新加载列表，**Then** 返回结果顺序变化但筛选口径不变。

---

### User Story 3 - 安全访问与可审计 (Priority: P3)

作为系统所有者，我需要只有管理员可访问该统计能力，并能追溯谁在何时使用了哪些筛选条件。

**Why this priority**: 收入数据敏感，必须满足最小权限和审计要求。

**Independent Test**: 非管理员访问被拒绝；管理员访问成功且形成可检索的操作记录。

**Acceptance Scenarios**:

1. **Given** 非管理员用户尝试访问收入统计，**When** 发起查询，**Then** 系统拒绝访问并返回明确错误信息。
2. **Given** 管理员完成一次统计查询，**When** 查看审计记录，**Then** 可见该查询的操作人、时间和筛选摘要。

### Edge Cases

- 当时间范围超出平台允许上限时，系统应拒绝并提示可用范围。
- 当所选范围内无收入数据时，系统应返回空结果和零值指标，而不是报错。
- 当同比或环比缺少可对比基准时，系统应明确标识“不可比”。
- 当层级筛选值失效或不存在时，系统应返回明确的参数错误。

## Requirements *(mandatory)*

### Assumptions

- 本功能仅面向后台管理员，不面向普通用户。
- 统计范围基于平台内已入账的真实收入记录，不使用模拟数据。
- 商品筛选遵循严格级联关系：类型 → 地区 → 线路 → 套餐。

### Functional Requirements

- **FR-001**: 系统必须允许管理员选择可配置范围内的任意起止时间进行收入统计。
- **FR-002**: 系统必须支持按以下四个商品层级进行统计：类型、地区、线路、套餐，且层级关系为递进结构。
- **FR-003**: 当选择下级层级时，系统必须要求并校验其上级层级筛选条件（例如查询套餐前必须明确类型、地区、线路范围）。
- **FR-004**: 系统必须返回与筛选条件一致的收入占比结果，用于占比图展示。
- **FR-005**: 系统必须返回与筛选条件一致的收入趋势结果，用于趋势图展示。
- **FR-006**: 系统必须返回同比与环比指标，并明确标识是否可比。
- **FR-007**: 系统必须返回同口径的收入 Top5 排名结果。
- **FR-008**: 系统必须提供收入明细表查询能力，并支持分页和排序。
- **FR-009**: 明细表与总览统计必须使用一致筛选口径，避免结果不一致。
- **FR-010**: 系统必须仅允许管理员访问收入统计能力，非管理员请求必须被拒绝。
- **FR-011**: 系统必须提供稳定且可理解的错误反馈，覆盖参数错误、权限错误和数据不可比场景。
- **FR-012**: 系统必须记录统计查询的审计信息，至少包含操作人、时间和查询条件摘要。

### Constitution Alignment Requirements *(mandatory)*

- **CA-001 (Architecture)**: 本功能在职责划分上必须保持清晰边界，避免将业务规则与展示或数据访问职责混用。
- **CA-002 (Financial Safety)**: 本功能的收入口径必须可追溯、可审计，且不引入会改变原始财务事实的隐式修正。
- **CA-003 (Contracts & Validation)**: 本功能对外输入与输出必须定义清晰、校验一致、错误语义稳定。
- **CA-004 (Performance)**: 本功能必须在目标数据量下保持可接受的查询与页面等待体验。
- **CA-005 (Observability & Security)**: 本功能必须具备可追踪的操作日志与服务端权限控制，确保敏感数据访问可审计。

### Key Entities *(include if feature involves data)*

- **收入统计查询**: 一次统计请求的筛选条件集合（时间范围、层级、层级值、分页与排序）。
- **收入总览指标**: 汇总指标集合（总收入、同比、环比、可比标识）。
- **占比项**: 某个层级维度值对应的收入与占比。
- **趋势点**: 某个时间桶对应的收入值。
- **Top 项**: 收入排名前五的维度项。
- **收入明细记录**: 可追溯到原始业务记录的单条收入信息。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 90% 的管理员可在 1 分钟内完成一次“选择范围并查看完整收入总览”的任务。
- **SC-002**: 在标准运营数据规模下，95% 的统计查询可在 3 秒内返回可展示结果。
- **SC-003**: 抽样核对中，收入总览结果与明细汇总的一致率达到 100%。
- **SC-004**: 非管理员对该功能的访问拦截率达到 100%。
- **SC-005**: 对统计能力的关键查询操作，审计记录覆盖率达到 100%。
